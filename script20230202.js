let gameData = {
  "decks": [
    {
      "code": "w-humans",
      "name": "White Humans",
      "set": "basic",
      "color": "w",
      "description" : "Aint white it aint right."
    },
    {
      "code": "w-lifegain",
      "name": "White Lifegain",
      "set": "intermediate",
      "color": "w",
      "description" : "Gain some life yo."
    },
    {
      "code": "w-vehicles",
      "name": "White Vehicle Reanimator",
      "set": "intermediate",
      "color": "w",
      "description" : "Boats and hoes."
    },
    {
      "code": "w-auras",
      "name": "White Auras",
      "set": "advanced",
      "color": "w",
      "description" : "Pump yo dudes."
    },


    {
      "code": "u-gowide",
      "name": "Blue Go Wide",
      "set": "basic",
      "color": "u",
      "description" : "Zombie swarm fo yo ass."
    },
    {
      "code": "u-draw",
      "name": "Blue Draw",
      "set": "intermediate",
      "color": "u",
      "description" : "Draw dem cards."
    },
    {
      "code": "u-spirits",
      "name": "Blue Spirits",
      "set": "intermediate",
      "color": "u",
      "description" : "Spook magook boys."
    },
    {
      "code": "u-tempo",
      "name": "Blue Tempo",
      "set": "advanced",
      "color": "u",
      "description" : "freeze biatch."
    },

    
    {
      "code": "b-aggro",
      "name": "Black Aggro",
      "set": "basic",
      "color": "b",
      "description" : "Beatdown boys."
    },
    {
      "code": "b-control",
      "name": "Black Control",
      "set": "intermediate",
      "color": "b",
      "description" : "Yo shit ded."
    },
    {
      "code": "b-sacrifice",
      "name": "Black Sacrifice",
      "set": "intermediate",
      "color": "b",
      "description" : "Sac and smack."
    },
    {
      "code": "b-discard",
      "name": "Black Discard",
      "set": "advanced",
      "color": "b",
      "description" : "Hide yo cards."
    },


    {
      "code": "r-rdw",
      "name": "RDW",
      "set": "basic",
      "color": "r",
      "description" : "Smash face."
    },
    {
      "code": "r-bigred",
      "name": "Big Red",
      "set": "intermediate",
      "color": "r",
      "description" : "Big red boys that like to hurt people."
    },
    {
      "code": "r-artifacts",
      "name": "Artifacts",
      "set": "intermediate",
      "color": "r",
      "description" : "Create and destroy robots."
    },
    {
      "code": "r-burn",
      "name": "Burn",
      "set": "advanced",
      "color": "r",
      "description" : "Come on Pookie, lets burn this mf down."
    },


    {
      "code": "g-devotion",
      "name": "Green Devotion",
      "set": "basic",
      "color": "g",
      "description" : "Green is good."
    },
    {
      "code": "g-deathtouch",
      "name": "Deathtouch",
      "set": "intermediate",
      "color": "g",
      "description" : "Wait. What dart?"
    },
    {
      "code": "g-ramp",
      "name": "Ramp",
      "set": "intermediate",
      "color": "g",
      "description" : "Get out the lands."
    },
    {
      "code": "g-counters",
      "name": "Counters",
      "set": "advanced",
      "color": "g",
      "description" : "These buff boys will pump you up."
    },


    {
      "code": "wu-fliers",
      "name": "Uw Fliers",
      "set": "intermediate",
      "color": "wu",
      "description" : "Just some feathered friends."
    },
    {
      "code": "wu-drawgo",
      "name": "Wu Draw Go",
      "set": "advanced",
      "color": "wu",
      "description" : "Pass the turn."
    },


    {
      "code": "wb-clerics",
      "name": "Wb Clerics",
      "set": "intermediate",
      "color": "wb",
      "description" : "Hail satan!"
    },
    {
      "code": "wb-drain",
      "name": "Bw Drain",
      "set": "advanced",
      "color": "wb",
      "description" : "Slurrrp."
    },


    {
      "code": "wr-equipment",
      "name": "Rw Equipment",
      "set": "intermediate",
      "color": "wr",
      "description" : "Suit up."
    },
    {
      "code": "wr-gowide",
      "name": "Wr Go Wide",
      "set": "advanced",
      "color": "wr",
      "description" : "Hope you like tokens."
    },


    {
      "code": "wg-coven",
      "name": "Gw Coven",
      "set": "intermediate",
      "color": "wg",
      "description" : "Three its the magic number."
    },
    {
      "code": "wg-enchantress",
      "name": "Wg Enchantress",
      "set": "advanced",
      "color": "wg",
      "description" : "Enchantments for your enchantments."
    },


    {
      "code": "ub-zombies",
      "name": "Bu Zombies",
      "set": "intermediate",
      "color": "ub",
      "description" : "Brains are back on the menu."
    },
    {
      "code": "ub-looting",
      "name": "Ub Looting",
      "set": "advanced",
      "color": "ub",
      "description" : "Toss it in the bin."
    },


    {
      "code": "ur-izzet",
      "name": "Ru Izzet",
      "set": "intermediate",
      "color": "ur",
      "description" : "Mad scientist magic."
    },
    {
      "code": "ur-artificers",
      "name": "Ur Artificers",
      "set": "advanced",
      "color": "ur",
      "description" : "Animating some shit."
    },


    {
      "code": "ug-spellramp",
      "name": "Gu Spell Ramp",
      "set": "intermediate",
      "color": "ug",
      "description" : "Magic its what plants crave."
    },
    {
      "code": "ug-selfmill",
      "name": "Ug Self Mill",
      "set": "advanced",
      "color": "ug",
      "description" : "The library is a resource."
    },


    {
      "code": "br-vampires",
      "name": "Rb Vampires",
      "set": "intermediate",
      "color": "br",
      "description" : "Ah ah ah ah."
    },
    {
      "code": "br-sacrifice",
      "name": "Br Sacrifice",
      "set": "advanced",
      "color": "br",
      "description" : "Plenty of meat for the grinder."
    },


    {
      "code": "bg-elves",
      "name": "Gb Elves",
      "set": "intermediate",
      "color": "bg",
      "description" : "Killing you and looking good doing it."
    },
    {
      "code": "bg-reanimator",
      "name": "Bg Reanimator",
      "set": "advanced",
      "color": "bg",
      "description" : "Look who's back."
    },


    {
      "code": "rg-gruul",
      "name": "Gr Gruul",
      "set": "intermediate",
      "color": "rg",
      "description" : "Oh look some stuff to smash."
    },
    {
      "code": "rg-domain",
      "name": "Gr Domain",
      "set": "advanced",
      "color": "rg",
      "description" : "Pick a color any color."
    }
  ]
}

// ============================================================================
// Initialize the draft parameters and generate interface elements
var draftNumPlayers = new URLSearchParams(window.location.search).get("draftNumPlayers");
    draftNumPlayers = parseInt(draftNumPlayers);
var arrPlayerData = [];

var draftFirstPlayerType = new URLSearchParams(window.location.search).get("draftFirstPlayerType"); // "p1" or "random"
var draftSet = new URLSearchParams(window.location.search).get("draftSet");
var draftPickType = new URLSearchParams(window.location.search).get("draftPickType");
var draftBans = new URLSearchParams(window.location.search).get("draftBans");


// create arrPlayerData and populate with players, also generate playerCard blocks
for (let i = 0; i < (draftNumPlayers); i++) {

  var playerNum = (i + 1);
  var playerName = new URLSearchParams(window.location.search).get("p" + playerNum + "Name");

  // create player data object and add to array
  const player = {
    name: playerName,
    data: "Here is some pointless data!"
  };
  arrPlayerData.push(player);

  var playerCardContainer = document.getElementById("js-playerCard-container");
  var playerCard = document.createElement('div');

  playerCard.classList.add('playerCard');
  playerCard.classList.add('playerCard--p' + playerNum);
  
  playerCard.innerHTML = `
      <div class="playerCard__pick" id="js-playerCard-p` + playerNum + `-pick1"></div>
      <input type="hidden" name="p` + playerNum + `Pick1" id="js-p` + playerNum + `-pick1-input" value="none">
      <div class="playerCard__pick" id="js-playerCard-p` + playerNum + `-pick2"></div>
      <input type="hidden" name="p` + playerNum + `Pick2" id="js-p` + playerNum + `-pick2-input" value="none">
      <h2 class="playerCard__playerName" id="js-playerCard-p` + playerNum + `Name">` + playerName + `</h2>
      <p class="playerCard__subHeading" id="js-playerCard-p` + playerNum + `Subheading"></p>`

    playerCardContainer.appendChild(playerCard);

}

//console.log(arrPlayerData);

// create game state hidden inputs
var draftStateDataElement = document.getElementById("js-draft-state-data");
var stateDataInput = document.createElement("input");
stateDataInput.type = "hidden";
stateDataInput.value = "none";
stateDataInput.name = "draftCurrentDeckSelection";
stateDataInput.id = "js-draftCurrentDeckSelection";
draftStateDataElement.appendChild(stateDataInput);

stateDataInput = document.createElement("input");
stateDataInput.type = "hidden";
stateDataInput.value = "none";
stateDataInput.name = "draftCurrentPickTarget";
stateDataInput.id = "js-draftCurrentPickTarget";
draftStateDataElement.appendChild(stateDataInput);

let deckGrid = document.getElementById('js-deckGrid');
let deckInfoLeft = document.getElementById('js-deckLightbox__contentLeft');
let deckInfoRight = document.getElementById('js-deckLightbox__contentRight');
let draftConfirmPickButton = document.getElementById('js-confirm-pick-button');

let draftCurrentPickTarget = document.getElementById('js-draftCurrentPickTarget'); // current pick target hidden element
let draftCurrentDeckSelection = document.getElementById('js-draftCurrentDeckSelection'); // current selected deck hidden element
let draftCurrentPickPlayerCardImg = ""; // player card deck image for current pick

//console.log(draftCurrentDeckSelection);


// on change of current pick target hidden input, prepare for a draft pick (or clear styling if no pick)
draftCurrentPickTarget.addEventListener('change', function(event) {

  console.log('draftCurrentPickTarget.addEventListener CHANGE triggered')

  if (this.value == "none") {

    // no current draft pick, clear styling
    console.log('no current pick');

    deckGrid.classList.remove("deckGrid--p1Pick");
    deckGrid.classList.remove("deckGrid--p2Pick");
    deckGrid.classList.remove("deckGrid--p3Pick");
    deckGrid.classList.remove("deckGrid--p4Pick");

    const playerCardElements = document.querySelectorAll('.playerCard__pick');
    playerCardElements.forEach(element => {
      element.classList.remove('playerCard__pick--pickTarget');
    });

    // figure out what to do next:

    console.log(draftNumPlayers + '-1  <=  ' + intDraftPicksCurrentPlayerIndex + ' = ' + eval((draftNumPlayers-1) <= intDraftPicksCurrentPlayerIndex));

    if ((draftNumPlayers-1) <= intDraftPicksCurrentPlayerIndex) { 
      // all players have picked a deck for this round
      console.log('all players have picked for this round.');

      // move to next pick in the array arrDraftPicksOrdering
      arrDraftPicksOrderingCurrent = arrDraftPicksOrderingCurrent + 1;

      // set new pick based on arrDraftPicksOrdering
      //var arrDraftPicksOrdering = ["deck", "ban", "deck"]; // TODO: dynamically create this array
      //var arrDraftPicksOrderingCurrent = 0;

      // go to the next pick in the arrDraftPicksOrderingCurrent array
      arrDraftPicksOrderingCurrent = arrDraftPicksOrderingCurrent + 1;

      // go to the first player in the arrDraftPicksPlayerOrder array
      intDraftPicksCurrentPlayerIndex = 0;

      draftCurrentPickTarget.value = 'p'+ arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex] + '-' + arrDraftPicksOrdering[arrDraftPicksOrderingCurrent];
      draftCurrentPickTarget.dispatchEvent(new Event('change'));

      
    } else {

      // not all players have picked a deck for this round
      console.log('NOT all players have picked for this round.');

      intDraftPicksCurrentPlayerIndex = intDraftPicksCurrentPlayerIndex + 1;
      console.log('intDraftPicksCurrentPlayerIndex = ' + intDraftPicksCurrentPlayerIndex);
      console.log('arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex] = ' + arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex]);

      draftCurrentPickTarget.value = 'p' + arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex] + '-pick1';
      draftCurrentPickTarget.dispatchEvent(new Event('change'));

      
    }
    
    console.log('arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex]: ' + arrDraftPicksPlayerOrder[intDraftPicksCurrentPlayerIndex]);


  } else {

    // prepare for deck/ban pick selection
    var tempPickTargetInputValue = this.value;
    console.log('pick: ' + tempPickTargetInputValue);
    
    var draftCurrentPickTargetPlayer = tempPickTargetInputValue.slice(0, 2);
    var draftCurrentPickPickNumber;
    
    let index = tempPickTargetInputValue.indexOf("pick");
    
    if (index !== -1) {
      draftCurrentPickPickNumber = tempPickTargetInputValue.charAt(index + "pick".length);
      console.log("The word 'pick' was found");
    } else {
      console.log("The word 'pick' was not found");
    }
  
    console.log('draftCurrentPickPlayerCardImg ID: js-playerCard-' + draftCurrentPickTargetPlayer + '-pick' + draftCurrentPickPickNumber);

    draftCurrentPickPlayerCardImg = document.getElementById('js-playerCard-' + draftCurrentPickTargetPlayer + '-pick' + draftCurrentPickPickNumber);
  
    // show styling on deck grid
    deckGrid.classList.add("deckGrid--p1Pick");

    //console.log(draftCurrentPickPlayerCardImg);

    // show styling on player card pick
    draftCurrentPickPlayerCardImg.classList.add("playerCard__pick--pickTarget");
    

  
  }
  
});

// confirm the selected pick -- assign the pick to the appropriate player
function confirmSelectedPick(){

  // assign selected deck to current pick target
  
  console.log('confirm ' + draftCurrentDeckSelection.value + ' for ' + draftCurrentPickTarget.value);
  console.log('js-playerCard-' + draftCurrentPickTarget.value);

  if (draftCurrentPickTarget.value != "none"){
    draftCurrentPickPlayerCardImg = document.getElementById('js-playerCard-' + draftCurrentPickTarget.value);

    console.log("draftCurrentPickPlayerCardImg:" + draftCurrentPickPlayerCardImg);

    draftCurrentPickPlayerCardImg.style.backgroundImage = 'url("img/'+ draftCurrentDeckSelection.value + '.png';
    draftCurrentPickTarget.value = "none";
    draftCurrentPickTarget.dispatchEvent(new Event('change'));
  }

  hideDeckLightbox();
  
}

/*
let timer = 5;
let countdown = setInterval(function() {
    timer--;
    console.log(timer + " seconds remaining");
    if (timer === 0) {
        clearInterval(countdown);
        draftCurrentPickTarget.value = 'p1-p2'; // set current pick target hidden element
        draftCurrentPickTarget.dispatchEvent(new Event('change'));
    }
}, 1000);
*/

// ============================================================================
// preload deck images
let deckImages = [];
// loop through the decks in the JSON data
gameData.decks.forEach((deck, index) => {

        //PRELOAD IMAGES: create a new image object and set the source to the deck's image
        let img = new Image();
        img.src = deck.image;
        // add the image object to the deckImages array
        deckImages.push(img);
});


// ============================================================================
// deck lightbox open/close functions
const deckLightbox = document.getElementById("js-deckLightbox");

let confirmSelectedPickHandler = () => {
  confirmSelectedPick();
};

function showDeckLightbox(boolIsDraftPick) {
  deckLightbox.classList.add("deckLightbox--show");

  if (boolIsDraftPick) {
    draftConfirmPickButton.addEventListener("click", confirmSelectedPickHandler);
  }
}

function hideDeckLightbox() {
  deckLightbox.classList.remove("deckLightbox--show");

  draftConfirmPickButton.removeEventListener("click", confirmSelectedPickHandler);
  console.log('ok remove draftConfirmPickButton listener');
}


// close lightbox when user hits esc
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    hideDeckLightbox();
  }
});


// ============================================================================
// Dynamically generated lightbox overlay 

function generateLightbox(lightboxContent){

  // create lightbox elements
  const lightboxOverlay = document.createElement('div');
  lightboxOverlay.classList.add('lightbox-overlay');

  const lightbox = document.createElement('div');
  lightbox.classList.add('lightbox');
  lightbox.innerHTML = '<p style="padding-bottom:16px;">' + lightboxContent + '</p><button id="close-lightbox-button">OK</button>';

  lightboxOverlay.appendChild(lightbox);
  document.body.appendChild(lightboxOverlay);

  const closeLightboxButton = lightbox.querySelector('#close-lightbox-button');
  closeLightboxButton.addEventListener('click', () => {
    document.body.removeChild(lightboxOverlay);
  });

  lightboxOverlay.addEventListener('click', (event) => {
    if (event.target === lightboxOverlay) {
      document.body.removeChild(lightboxOverlay);
    }
  });

}


// ============================================================================
// Function to generate the deck select
function generateDeckPicker(pickType, selectedSet) {
  
      // does this deck meet requirements to be shown? (TODO: rewrite this section)
      let tempDeckData = structuredClone(gameData.decks);
      for (let i = tempDeckData.length - 1; i >= 0; i--) {
        if (selectedSet == "basic") {
          if (tempDeckData[i].set != selectedSet) {
            //console.log('splice ' + tempDeckData[i].name);
            tempDeckData.splice(i, 1);
          }
        } else if (selectedSet == "intermediate") {
          if (tempDeckData[i].set == "advanced") {
            //console.log('splice ' + tempDeckData[i].name);
            tempDeckData.splice(i, 1);
          }
        }
      }

      function generateDeckButton(objDeckData, boolAddTodeckGrid){

        let deckButton = document.createElement('button');
        deckButton.type = 'button';
        deckButton.classList.add('deckGrid__deckButton');
        deckButton.dataset.code = objDeckData.code; // data-code attribute
        deckButton.dataset.color = objDeckData.color; // data-color attribute
        deckButton.style = 'background-image: url("img/'+ objDeckData.code + '.png");';
        deckButton.addEventListener("click", () => {

          // set hidden state input
          draftCurrentDeckSelection.value = objDeckData.code;

          deckInfoLeft.style.background = 'url("img/'+ objDeckData.code + '.png")';
          deckInfoLeft.style.backgroundSize = '100%';
          deckInfoRight.innerHTML = `<h2 class="deckLightbox__heading">${objDeckData.name}</h2>
                                <p class="deckLightbox__description">${objDeckData.description}</p>
                                <button onclick="hideDeckLightbox()">Cancel</button>`

          // show deck lightbox, true it is for a deck pick
          showDeckLightbox(true);


          
        });
        
        // add sound effect on click - how is this even working?
        deckButton.addEventListener('click', function() {
          selectSound.currentTime = 0; // reset the current time to the start
          selectSound.play();
        });

        if (boolAddTodeckGrid) {
          deckGrid.appendChild(deckButton);
        } else {
          return deckButton;
        } 
      }

      // add styling modifier to deckGrid block
      deckGrid.classList.add('deckGrid__' + pickType + 'Pick');
      //console.log(gameData.decks);
      //console.log(tempDeckData);
      if (pickType == "standard"){

        // display all decks
        tempDeckData.forEach((deck, index) => {
          generateDeckButton(deck,"true");
        });

      } else if (pickType == "randomized"){

        // display 3 random decks
        const arrRandomDeckIDs = [];
        for (let i = 0; i < 3; i++) {
          let randomDeckNumber = Math.floor(Math.random() * tempDeckData.length);
          while (arrRandomDeckIDs.includes(randomDeckNumber)) {
            randomDeckNumber = Math.floor(Math.random() * tempDeckData.length);
          }
          arrRandomDeckIDs.push(randomDeckNumber);
          generateDeckButton(tempDeckData[randomDeckNumber],"true");
        }
        
      } else {
        alert('unrecognized pick type')
      }

}


// ============================================================================
// Function to initiate first draft deck/ban pick by setting current pick target hidden input
function draftInitializeFirstPick(firstPickPlayer, boolIsBan){

    if (boolIsBan) { // this pick is a ban

      alert('uh oh it wants a ban! help I need an adult!')

    } else { // not a ban, must be a deck pick

      // figure out what pick # this is for current player - TODO: decide if this check is even neccesary

      let currentPlayerPick1InputValue = document.getElementById('js-p' + firstPickPlayer + '-pick1-input');
          currentPlayerPick1InputValue = currentPlayerPick1InputValue.value;
          console.log("currentPlayerPick1InputValue: " + currentPlayerPick1InputValue);
      let currentPlayerPick2InputValue = document.getElementById('js-p' + firstPickPlayer + '-pick2-input');
          currentPlayerPick2InputValue = currentPlayerPick2InputValue.value;
          console.log("currentPlayerPick2InputValue: " + currentPlayerPick2InputValue);

      if (currentPlayerPick1InputValue == 'none' || currentPlayerPick2InputValue == 'none'){
        draftCurrentPickTarget.value = 'p' + firstPickPlayer + '-pick1'; // set current pick target hidden element - going to assume it is always deck #1
        draftCurrentPickTarget.dispatchEvent(new Event('change'));

      } else { // no deck picks left 
        alert ('Error: both picks from player ' + firstPickPlayer + ' are completed')
      }

    }

}


// ============================================================================
// Determine starting player and set player pick order

function draftInitializePlayerPickOrder(){

  console.log('initialize pick order - type: ' + draftFirstPlayerType);

  // set initial order with p1 first
  let arrTempPlayerOrder = [];
  for (let i = 0; i <= (draftNumPlayers-1); i++) {
    arrTempPlayerOrder.push(i+1);
  }

  if (draftFirstPlayerType == "p1") {

    return arrTempPlayerOrder;
    
  } else if (draftFirstPlayerType == "random") {

    // randomize player order array
    function createTurnOrder(numPlayers) {

      let firstPlayer = arrTempPlayerOrder.splice(Math.floor(Math.random() * arrTempPlayerOrder.length), 1)[0];
      let turnOrder = [firstPlayer];

      while (arrTempPlayerOrder.length > 0) {
        let nextPlayer = arrTempPlayerOrder.splice(arrTempPlayerOrder .indexOf(firstPlayer % numPlayers + 1), 1)[0];
        turnOrder.push(nextPlayer);
        firstPlayer = nextPlayer;
      }

      return turnOrder;
    }

    return createTurnOrder(draftNumPlayers);

  } else {
    alert('uh oh unrecognized first player pick type');
  }

}


// ============================================================================
// Start Draft

var arrDraftPicksOrdering = ["deck", "ban", "deck"]; // TODO: dynamically create this array
var arrDraftPicksOrderingCurrent = 0;

// get correct player pick order based on pick type selected
var arrDraftPicksPlayerOrder = draftInitializePlayerPickOrder();
console.log("arrDraftPicksPlayerOrder: " + arrDraftPicksPlayerOrder);
console.log("arrDraftPicksPlayerOrder[0]: " + arrDraftPicksPlayerOrder[0]);
console.log("arrDraftPicksPlayerOrder[1]: " + arrDraftPicksPlayerOrder[1]);
console.log("arrDraftPicksPlayerOrder[2]: " + arrDraftPicksPlayerOrder[2]);
console.log("arrDraftPicksPlayerOrder[3]: " + arrDraftPicksPlayerOrder[3]);


var arrDraftPicksCurrentPlayer = arrDraftPicksPlayerOrder[0];
var intDraftPicksCurrentPlayerIndex = 0;

generateLightbox("player " + arrDraftPicksPlayerOrder[0] + " goes first!<br><br>Lets draft " + draftSet + " decks with " + draftNumPlayers + " players using " + draftPickType + " pick (bans: " + draftBans + ")");

console.log("generateDeckPicker(" + draftPickType + "," + draftSet + ")");
generateDeckPicker(draftPickType, draftSet);

console.log("draftInitializeFirstPick: " + arrDraftPicksPlayerOrder[0], false);
draftInitializeFirstPick(arrDraftPicksPlayerOrder[0], false);

